---
const base = import.meta.env.BASE_URL;
---

<li class="search-box" role="none">
  <button
    class="search-box__btn"
    id="search-btn"
    type="button"
    aria-label="Buscar en el sitio"
    aria-expanded="false"
  >
    <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
  </button>

  <div class="search-box__panel" id="search-panel" hidden>
    <div class="search-box__input-wrap">
      <i class="fa-solid fa-magnifying-glass search-box__input-icon" aria-hidden="true"></i>
      <input
        type="search"
        class="search-box__input"
        id="search-input"
        placeholder="Buscar paginas, secciones..."
        autocomplete="off"
        aria-label="Buscar en el sitio"
      />
      <kbd class="search-box__kbd">Esc</kbd>
    </div>
    <ul class="search-box__results" id="search-results" role="listbox"></ul>
    <div class="search-box__empty" id="search-empty" hidden>
      <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
      Sin resultados
    </div>
    <div class="search-box__hint" id="search-hint">
      <span>Escriba para buscar</span>
      <span class="search-box__shortcut"><kbd>Ctrl</kbd> + <kbd>K</kbd></span>
    </div>
  </div>

  <div class="search-box__overlay" id="search-overlay" hidden></div>
</li>

<style>
  /* Boton lupa */
  .search-box {
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-box__btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: var(--icon-xs);
    height: var(--icon-xs);
    background: transparent;
    border: 1.5px solid rgba(255, 255, 255, 0.4);
    border-radius: var(--radius-full);
    color: rgba(255, 255, 255, 0.9);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: 0.85rem;
    margin-left: var(--space-2);
  }

  .search-box__btn:hover {
    background: var(--itrc-gold);
    border-color: var(--itrc-gold);
    color: var(--itrc-navy);
  }

  /* Panel de busqueda */
  .search-box__panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 520px;
    background: var(--white);
    border-radius: var(--radius-xl);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
    z-index: 10001;
    overflow: hidden;
    animation: searchSlideIn 0.2s ease;
  }

  @keyframes searchSlideIn {
    from { opacity: 0; transform: translate(-50%, -48%); }
    to { opacity: 1; transform: translate(-50%, -50%); }
  }

  /* Input */
  .search-box__input-wrap {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4) var(--space-5);
    border-bottom: 1px solid var(--gray-200);
  }

  .search-box__input-icon {
    color: var(--gray-400);
    font-size: var(--font-size-base);
  }

  .search-box__input {
    flex: 1;
    border: none;
    outline: none;
    font-size: var(--font-size-base);
    color: var(--gray-900);
    background: transparent;
    font-family: inherit;
  }

  .search-box__input::placeholder {
    color: var(--gray-400);
  }

  .search-box__kbd {
    font-size: var(--font-size-xs);
    color: var(--gray-400);
    background: var(--gray-100);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--gray-200);
    font-family: inherit;
  }

  /* Resultados */
  .search-box__results {
    list-style: none;
    margin: 0;
    padding: var(--space-2);
    max-height: 320px;
    overflow-y: auto;
  }

  .search-box__results:empty {
    display: none;
  }

  .search-box__result {
    margin: 0;
  }

  .search-box__result a {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--gray-700);
    transition: background var(--transition-fast);
  }

  .search-box__result a:hover,
  .search-box__result a.active {
    background: var(--gray-100);
    color: var(--itrc-navy);
  }

  .search-box__result-icon {
    width: var(--icon-2xs);
    height: var(--icon-2xs);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
    font-size: 0.75rem;
    flex-shrink: 0;
  }

  .search-box__result-icon--page {
    background: rgba(0, 33, 71, 0.1);
    color: var(--itrc-navy);
  }

  .search-box__result-icon--section {
    background: rgba(179, 139, 64, 0.15);
    color: var(--itrc-gold);
  }

  .search-box__result-icon--news {
    background: rgba(9, 67, 181, 0.1);
    color: var(--govco-blue);
  }

  .search-box__result-text {
    flex: 1;
    min-width: 0;
  }

  .search-box__result-title {
    font-size: var(--font-size-sm);
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .search-box__result-parent {
    font-size: var(--font-size-xs);
    color: var(--gray-400);
  }

  /* Empty state */
  .search-box__empty {
    padding: var(--space-8);
    text-align: center;
    color: var(--gray-400);
    font-size: var(--font-size-sm);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2);
  }

  .search-box__empty i {
    font-size: var(--font-size-2xl);
  }

  /* Hint */
  .search-box__hint {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3) var(--space-5);
    border-top: 1px solid var(--gray-100);
    font-size: var(--font-size-xs);
    color: var(--gray-400);
  }

  .search-box__shortcut {
    display: flex;
    gap: 4px;
  }

  .search-box__shortcut kbd {
    font-size: 0.65rem;
    background: var(--gray-100);
    padding: 1px 5px;
    border-radius: 3px;
    border: 1px solid var(--gray-200);
    font-family: inherit;
  }

  /* Overlay */
  .search-box__overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    backdrop-filter: blur(2px);
  }

  /* Mobile */
  @media (max-width: 1024px) {
    .search-box__btn {
      width: 100%;
      height: auto;
      border-radius: var(--radius-md);
      border-color: rgba(255, 255, 255, 0.2);
      padding: var(--space-3) var(--space-4);
      justify-content: center;
      gap: var(--space-2);
      margin-left: 0;
      margin: var(--space-2) var(--space-4);
    }

    .search-box__btn::after {
      content: 'Buscar';
      font-size: var(--font-size-sm);
      font-weight: 500;
    }

    .search-box__panel {
      width: 95%;
      top: 30%;
    }
  }
</style>

<script is:inline data-base={base}>
(function() {
  const BASE = document.currentScript.getAttribute('data-base') || '/';
  let searchIndex = null;
  let activeIndex = -1;

  function normalize(str) {
    return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  }

  function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function resolveUrl(url) {
    if (!url || url.startsWith('http') || url.startsWith('//')) return url;
    if (url.startsWith('/')) return BASE + url.slice(1);
    return url;
  }

  function getIconClass(kind) {
    if (kind === 'p') return 'page';
    if (kind === 's') return 'section';
    return 'news';
  }

  function getIconFA(kind) {
    if (kind === 'p') return 'fa-file-lines';
    if (kind === 's') return 'fa-layer-group';
    return 'fa-newspaper';
  }

  function loadIndex(callback) {
    if (searchIndex) return callback(searchIndex);
    fetch(BASE + 'search-index.json')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        searchIndex = data;
        callback(data);
      })
      .catch(function() { callback([]); });
  }

  function renderResults(results) {
    const list = document.getElementById('search-results');
    const empty = document.getElementById('search-empty');
    const hint = document.getElementById('search-hint');
    const input = document.getElementById('search-input');
    const query = input ? input.value.trim() : '';

    if (!list || !empty || !hint) return;

    if (!query) {
      list.innerHTML = '';
      empty.hidden = true;
      hint.hidden = false;
      return;
    }

    hint.hidden = true;

    if (results.length === 0) {
      list.innerHTML = '';
      empty.hidden = false;
      return;
    }

    empty.hidden = true;
    activeIndex = -1;
    list.innerHTML = results.slice(0, 8).map(function(r, i) {
      const iconType = getIconClass(r.k);
      const iconFA = getIconFA(r.k);
      const url = resolveUrl(r.u);
      const external = url.startsWith('http');
      const target = external ? ' target="_blank" rel="noopener noreferrer"' : '';
      return '<li class="search-box__result" role="option">' +
        '<a href="' + url + '"' + target + ' data-idx="' + i + '">' +
          '<span class="search-box__result-icon search-box__result-icon--' + iconType + '">' +
            '<i class="fa-solid ' + iconFA + '"></i>' +
          '</span>' +
          '<span class="search-box__result-text">' +
            '<span class="search-box__result-title">' + escapeHtml(r.t) + '</span>' +
            (r.p ? '<span class="search-box__result-parent">' + escapeHtml(r.p) + '</span>' : '') +
          '</span>' +
        '</a>' +
      '</li>';
    }).join('');
  }

  function search(query) {
    if (!query) return renderResults([]);
    loadIndex(function(index) {
      const q = normalize(query);
      const scored = [];
      for (let i = 0; i < index.length; i++) {
        const entry = index[i];
        const title = normalize(entry.t);
        const parent = entry.p ? normalize(entry.p) : '';
        let score = 0;
        if (title === q) score = 100;
        else if (title.startsWith(q)) score = 80;
        else if (title.indexOf(q) !== -1) score = 60;
        else if (parent.indexOf(q) !== -1) score = 30;
        if (score > 0) scored.push({ entry: entry, score: score });
      }
      scored.sort(function(a, b) { return b.score - a.score; });
      renderResults(scored.map(function(s) { return s.entry; }));
    });
  }

  function openSearch() {
    const panel = document.getElementById('search-panel');
    const overlay = document.getElementById('search-overlay');
    const btn = document.getElementById('search-btn');
    const input = document.getElementById('search-input');
    if (!panel || panel.hidden === false) return;
    panel.hidden = false;
    if (overlay) overlay.hidden = false;
    if (btn) btn.setAttribute('aria-expanded', 'true');
    if (input) { input.value = ''; input.focus(); }
    renderResults([]);
  }

  function closeSearch() {
    const panel = document.getElementById('search-panel');
    const overlay = document.getElementById('search-overlay');
    const btn = document.getElementById('search-btn');
    if (panel) panel.hidden = true;
    if (overlay) overlay.hidden = true;
    if (btn) { btn.setAttribute('aria-expanded', 'false'); btn.focus(); }
  }

  function navigateResults(direction) {
    const links = document.querySelectorAll('#search-results a');
    if (links.length === 0) return;
    links.forEach(function(l) { l.classList.remove('active'); });
    activeIndex += direction;
    if (activeIndex < 0) activeIndex = links.length - 1;
    if (activeIndex >= links.length) activeIndex = 0;
    links[activeIndex].classList.add('active');
    links[activeIndex].scrollIntoView({ block: 'nearest' });
  }

  function initSearch() {
    const btn = document.getElementById('search-btn');
    const input = document.getElementById('search-input');
    const overlay = document.getElementById('search-overlay');

    if (btn) btn.addEventListener('click', openSearch);
    if (overlay) overlay.addEventListener('click', closeSearch);

    if (input) {
      let timer;
      input.addEventListener('input', function() {
        clearTimeout(timer);
        const val = input.value.trim();
        timer = setTimeout(function() { search(val); }, 120);
      });

      input.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') { closeSearch(); e.preventDefault(); }
        if (e.key === 'ArrowDown') { navigateResults(1); e.preventDefault(); }
        if (e.key === 'ArrowUp') { navigateResults(-1); e.preventDefault(); }
        if (e.key === 'Enter') {
          const active = document.querySelector('#search-results a.active');
          if (active) { active.click(); closeSearch(); }
        }
      });
    }

    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const panel = document.getElementById('search-panel');
        if (panel && panel.hidden) openSearch();
        else closeSearch();
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearch);
  } else {
    initSearch();
  }
})();
</script>
