---
import '../styles/global.css';
import GovcoBar from '../components/layout/GovcoBar.astro';
import Header from '../components/layout/Header.astro';
import Navigation from '../components/layout/Navigation.astro';
import Footer from '../components/layout/Footer.astro';
import WcagWidget from '../components/WcagWidget.astro';

import siteConfig from '../content/settings/site.json';

interface Props {
  title: string;
  description?: string;
  class?: string;
}

const { title, description = siteConfig.description, class: className = '' } = Astro.props;
const pageTitle = `${title} | ${siteConfig.name}`;
const base = import.meta.env.BASE_URL;
---

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content={description}>
  <meta name="keywords" content={siteConfig.keywords?.join(', ')}>
  <meta name="author" content={siteConfig.name}>
  <meta name="robots" content="index, follow">

  <meta property="og:title" content={pageTitle}>
  <meta property="og:description" content={description}>
  <meta property="og:type" content="website">
  <meta property="og:locale" content="es_CO">

  <title>{pageTitle}</title>

  <link rel="icon" type="image/x-icon" href={`${base}favicon.ico`}>

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  >
</head>
<body class={className}>
  <a href="#main-content" class="skip-link">
    Saltar al contenido principal
  </a>

  <GovcoBar />
  <Header />
  <Navigation />

  <main id="main-content" tabindex="-1">
    <slot />
  </main>

  <Footer />
  <WcagWidget />
  <script is:inline>
    (function() {
      const scrollThreshold = 100;
      let isScrolled = false;

      function handleScroll() {
        const shouldBeScrolled = window.scrollY > scrollThreshold;
        if (shouldBeScrolled !== isScrolled) {
          isScrolled = shouldBeScrolled;
          document.body.classList.toggle('scrolled', isScrolled);
          if (!isScrolled) closeHeaderMenu();
        }
      }

      function closeHeaderMenu() {
        const headerBtn = document.getElementById('header-menu-btn');
        const navList = document.getElementById('main-nav');
        const navElement = document.querySelector('.nav');
        const overlay = document.getElementById('nav-overlay');

        if (headerBtn) headerBtn.setAttribute('aria-expanded', 'false');
        if (navElement) navElement.classList.remove('nav--header-menu-visible');
        if (navList) {
          navList.classList.remove('nav__list--header-menu-open');
          navList.querySelectorAll('.nav__item--open').forEach(function(item) {
            item.classList.remove('nav__item--open');
          });
          navList.querySelectorAll('.nav__item--has-dropdown .nav__link').forEach(function(link) {
            link.setAttribute('aria-expanded', 'false');
          });
        }
        if (overlay) overlay.classList.remove('nav__overlay--header-visible');
        document.body.classList.remove('menu-open');
      }

      function initHeaderMenu() {
        const headerBtn = document.getElementById('header-menu-btn');
        const navList = document.getElementById('main-nav');
        const navElement = document.querySelector('.nav');
        const overlay = document.getElementById('nav-overlay');
        const header = document.getElementById('main-header');

        if (!headerBtn || !navList) return;

        headerBtn.addEventListener('click', function() {
          const isOpen = headerBtn.getAttribute('aria-expanded') === 'true';

          if (isOpen) {
            closeHeaderMenu();
          } else {
            headerBtn.setAttribute('aria-expanded', 'true');
            if (navElement) navElement.classList.add('nav--header-menu-visible');

            const headerRect = header.getBoundingClientRect();
            navList.style.setProperty('--header-menu-top', headerRect.bottom + 'px');
            navList.style.setProperty('--header-menu-max-height', 'calc(100vh - ' + (headerRect.bottom + 24) + 'px)');

            navList.classList.add('nav__list--header-menu-open');
            if (overlay) overlay.classList.add('nav__overlay--header-visible');
          }
        });

        if (overlay) {
          overlay.addEventListener('click', function() {
            if (window.innerWidth > 1024) closeHeaderMenu();
          });
        }

        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && headerBtn.getAttribute('aria-expanded') === 'true') {
            closeHeaderMenu();
            headerBtn.focus();
          }
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          handleScroll();
          initHeaderMenu();
        });
      } else {
        handleScroll();
        initHeaderMenu();
      }

      window.addEventListener('scroll', handleScroll, { passive: true });
      window.addEventListener('resize', function() {
        const mobileToggle = document.getElementById('nav-toggle');
        if (window.innerWidth > 1024 && mobileToggle) {
          mobileToggle.setAttribute('aria-expanded', 'false');
        }
        closeHeaderMenu();
      });
    })();
  </script>
</body>
</html>
